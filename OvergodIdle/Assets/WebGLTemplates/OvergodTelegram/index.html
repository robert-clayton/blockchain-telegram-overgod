<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unity WebGL Player | {{{ PRODUCT_NAME }}}</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />
    <script>
      (function () {
        function mapTelegramUser(u) {
          if (!u) return {};
          return {
            id: u.id || 0,
            firstName: u.first_name || "",
            lastName: u.last_name || "",
            username: u.username || "",
            isBot: !!u.is_bot,
            isPremium: !!u.is_premium,
            allowsWriteToPm: undefined,
            addedToAttachmentMenu: undefined,
            languageCode: u.language_code || "",
            photoUrl: u.photo_url || "",
          };
        }

        function getTelegramInitUser() {
          try {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
              return mapTelegramUser(window.Telegram.WebApp.initDataUnsafe.user);
            }
          } catch (e) {}
          return null;
        }

        // Dev fallback via query: ?dev_user={"id":1,"first_name":"Dev","last_name":"User","username":"dev"}
        function getDevUser() {
          try {
            var params = new URLSearchParams(window.location.search);
            var raw = params.get("dev_user");
            if (raw) {
              var parsed = JSON.parse(raw);
              return mapTelegramUser(parsed);
            }
          } catch (e) {}
          return { id: 0, firstName: "Dev", lastName: "User", username: "dev" };
        }

        var user = getTelegramInitUser() || getDevUser();
        var initDataRaw = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || "";

        // Minimal instance expected by YesTMABridge/index.jslib
        window.TGMiniAppGameSDKInstance = {
          launchParams: {
            initData: { user: user },
            initDataRaw: initDataRaw,
            startParam: "",
          },
          wallet: {
            isConnected: false,
            address: "",
            connect: function () {},
            disconnect: function () {},
          },
          payments: {
            ton: { pay: function (amount, comment) {} },
          },
          miniAppSetHeaderColor: function (color) {},
          miniAppSetBgColor: function (color) {},
          miniAppSetBottomBarColor: function (color) {},
          miniAppClose: function () {},
          miniAppIsActive: function () { return true; },
          viewportExpand: function () {},
          viewportRequestFullscreen: function () {},
          backButtonShow: function () {},
          backButtonHide: function () {},
          enableConfirmation: function () {},
          disableConfirmation: function () {},
          enableVertical: function () {},
          disableVertical: function () {},
          shareStory: function () {},
          openTelegramLink: function () {},
          openLink: function () {},
          shareURL: function () {},
          requestVibration: function () {},
          addToHomeScreen: function () {},
          requestCheckHomeScreenStatus: function () {},
          requestPhoneAccess: function () {},
          requestWriteAccess: function () {},
          requestContact: function () {},
          requestEmojiStatusAccess: function () {},
          requestSetEmojiStatus: function () {},
          requestReadTextFromClipboard: function () {},
          requestTGMethod: function () {},
        };
      })();
    </script>
  </head>
  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-footer">
        <div id="unity-webgl-logo"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">{{{ PRODUCT_NAME }}}</div>
      </div>
    </div>
    <script>
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/{{{ LOADER_FILENAME }}}";
      var config = {
        dataUrl: buildUrl + "/{{{ DATA_FILENAME }}}",
        frameworkUrl: buildUrl + "/{{{ FRAMEWORK_FILENAME }}}",
        codeUrl: buildUrl + "/{{{ CODE_FILENAME }}}",
        #if MEMORY_FILENAME
        memoryUrl: buildUrl + "/{{{ MEMORY_FILENAME }}}",
        #endif
        #if SYMBOLS_FILENAME
        symbolsUrl: buildUrl + "/{{{ SYMBOLS_FILENAME }}}",
        #endif
        streamingAssetsUrl: "StreamingAssets",
        companyName: "{{{ COMPANY_NAME }}}",
        productName: "{{{ PRODUCT_NAME }}}",
        productVersion: "{{{ PRODUCT_VERSION }}}",
      };

      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var fullscreenButton = document.querySelector("#unity-fullscreen-button");
      var width0 = "{{{ WIDTH }}}px";
      var height0 = "{{{ HEIGHT }}}px";

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        container.className = "unity-mobile";
        config.devicePixelRatio = 1;
      } else {
        canvas.style.width = "{{{ WIDTH }}}px";
        canvas.style.height = "{{{ HEIGHT }}}px";
      }
      #if BACKGROUND_FILENAME
      canvas.style.background = "url('" + buildUrl + "/{{{ BACKGROUND_FILENAME.replace(/'/g, '%27') }}}') center / cover";
      #endif
      loadingBar.style.display = "block";

      document.addEventListener("fullscreenchange", function () {
        var p = document.getElementById("unity-container");
        var c = document.getElementById("unity-canvas");
        if (document.fullscreenElement) {
          width0 = c.style.width;
          height0 = c.style.height;
          setTimeout(function () {
            c.style.width = getComputedStyle(p).width;
            c.style.height = getComputedStyle(p).height;
          }, 250);
        } else {
          c.style.width = width0;
          c.style.height = height0;
        }
      });

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = function () {
        createUnityInstance(canvas, config, function (progress) {
          progressBarFull.style.width = 100 * progress + "%";
        })
          .then(function (unityInstance) {
            window.unityInstance = unityInstance;
            loadingBar.style.display = "none";
            fullscreenButton.onclick = function () {
              var p = document.getElementById("unity-container");
              var c = document.getElementById("unity-canvas");
              c.requestFullscreen = function () {
                p.requestFullscreen();
              };
              unityInstance.SetFullscreen(1);
            };
          })
          .catch(function (message) {
            alert(message);
          });
      };
      document.body.appendChild(script);
    </script>
  </body>
  </html>


