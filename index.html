<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unity WebGL Player | Overgod Idle</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: #000;
      }
      #unity-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
      }
      #unity-canvas {
        width: 100vw;
        height: 100vh;
        display: block;
      }
      #unity-loading-bar, #unity-footer { display: none; }

      #tg-fs-toggle {
        position: fixed;
        right: 12px;
        bottom: 12px;
        z-index: 10;
        background: rgba(0,0,0,0.5);
        color: #fff;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 8px;
        padding: 8px 12px;
        font-family: sans-serif;
        font-size: 14px;
        cursor: pointer;
        user-select: none;
      }
    </style>
    <script>
      (function () {
        function mapTelegramUser(u) {
          if (!u) return {};
          return {
            id: u.id || 0,
            firstName: u.first_name || "",
            lastName: u.last_name || "",
            username: u.username || "",
            isBot: !!u.is_bot,
            isPremium: !!u.is_premium,
            allowsWriteToPm: undefined,
            addedToAttachmentMenu: undefined,
            languageCode: u.language_code || "",
            photoUrl: u.photo_url || "",
          };
        }

        function getTelegramInitUser() {
          try {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
              return mapTelegramUser(window.Telegram.WebApp.initDataUnsafe.user);
            }
          } catch (e) {}
          return null;
        }

        // Dev fallback via query: ?dev_user={"id":1,"first_name":"Dev","last_name":"User","username":"dev"}
        function getDevUser() {
          try {
            var params = new URLSearchParams(window.location.search);
            var raw = params.get("dev_user");
            if (raw) {
              var parsed = JSON.parse(raw);
              return mapTelegramUser(parsed);
            }
          } catch (e) {}
          return { id: 0, firstName: "Dev", lastName: "User", username: "dev" };
        }

        var user = getTelegramInitUser() || getDevUser();
        var initDataRaw = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || "";

        // Minimal instance expected by YesTMABridge/index.jslib
        window.TGMiniAppGameSDKInstance = {
          launchParams: {
            initData: { user: user },
            initDataRaw: initDataRaw,
            startParam: "",
          },
          wallet: {
            isConnected: false,
            address: "",
            connect: function () {},
            disconnect: function () {},
          },
          payments: {
            ton: { pay: function (amount, comment) {} },
          },
          miniAppSetHeaderColor: function (color) {},
          miniAppSetBgColor: function (color) {},
          miniAppSetBottomBarColor: function (color) {},
          miniAppClose: function () {},
          miniAppIsActive: function () { return true; },
          viewportExpand: function () {},
          viewportRequestFullscreen: function () {},
          backButtonShow: function () {},
          backButtonHide: function () {},
          enableConfirmation: function () {},
          disableConfirmation: function () {},
          enableVertical: function () {},
          disableVertical: function () {},
          shareStory: function () {},
          openTelegramLink: function () {},
          openLink: function () {},
          shareURL: function () {},
          requestVibration: function () {},
          addToHomeScreen: function () {},
          requestCheckHomeScreenStatus: function () {},
          requestPhoneAccess: function () {},
          requestWriteAccess: function () {},
          requestContact: function () {},
          requestEmojiStatusAccess: function () {},
          requestSetEmojiStatus: function () {},
          requestReadTextFromClipboard: function () {},
          requestTGMethod: function () {},
        };
        // If weâ€™re running inside Telegram, ensure theme/init and viewport updates are propagated
        try {
          var tg = window.Telegram && window.Telegram.WebApp;
          if (tg) {
            tg.onEvent && tg.onEvent('themeChanged', function(){ /* no-op for now */ });
            tg.onEvent && tg.onEvent('viewportChanged', function(){
              if (window.unityInstance && window.unityInstance.SendMessage) {
                window.unityInstance.SendMessage('TelegramUserNameUI', 'ForceRefreshFromJS', '');
              }
            });
          }
        } catch (e) {}
      })();
    </script>
    <script>
      // Fullscreen toggle button for Telegram Mini App
      (function fullscreenToggle(){
        var isFull = false;
        function requestFS(){
          try {
            var tg = window.Telegram && window.Telegram.WebApp;
            if (tg && typeof tg.requestFullscreen === 'function') {
              tg.requestFullscreen();
            } else if (window.TelegramWebviewProxy && typeof window.TelegramWebviewProxy.postEvent === 'function') {
              window.TelegramWebviewProxy.postEvent('web_app_request_fullscreen', JSON.stringify({}));
            } else if (window.parent && window.parent.postMessage) {
              var msg = JSON.stringify({ eventType: 'web_app_request_fullscreen', eventData: {} });
              window.parent.postMessage(msg, 'https://web.telegram.org');
            }
            isFull = true;
          } catch (e) {}
        }
        function exitFS(){
          try {
            var tg = window.Telegram && window.Telegram.WebApp;
            if (tg && typeof tg.exitFullscreen === 'function') {
              tg.exitFullscreen();
            } else if (window.TelegramWebviewProxy && typeof window.TelegramWebviewProxy.postEvent === 'function') {
              window.TelegramWebviewProxy.postEvent('web_app_exit_fullscreen', JSON.stringify({}));
            } else if (window.parent && window.parent.postMessage) {
              var msg = JSON.stringify({ eventType: 'web_app_exit_fullscreen', eventData: {} });
              window.parent.postMessage(msg, 'https://web.telegram.org');
            }
            isFull = false;
          } catch (e) {}
        }
        function updateButton(){
          var btn = document.getElementById('tg-fs-toggle');
          if (!btn) return;
          btn.textContent = isFull ? 'Exit Fullscreen' : 'Go Fullscreen';
        }
        function toggle(){
          if (isFull) exitFS(); else requestFS();
          setTimeout(updateButton, 250);
        }
        // Listen to Telegram viewportChanged as a crude signal
        try {
          var tg = window.Telegram && window.Telegram.WebApp;
          if (tg && tg.onEvent) {
            tg.onEvent('viewportChanged', function(){ setTimeout(updateButton, 100); });
          }
        } catch (e) {}
        window.__tgToggleFS = toggle;
        document.addEventListener('DOMContentLoaded', updateButton);
      })();
    </script>
  </head>
  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas"></canvas>
      <div id="tg-fs-toggle" onclick="window.__tgToggleFS && window.__tgToggleFS()">Go Fullscreen</div>
    </div>
    <script>
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/WebGL.loader.js";
      var config = {
        dataUrl: buildUrl + "/WebGL.data.unityweb",
        frameworkUrl: buildUrl + "/WebGL.framework.js.unityweb",
        codeUrl: buildUrl + "/WebGL.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Overgod Idle",
        productVersion: "0.0.24",
      };

      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      // Fit to Telegram WebApp viewport if available
      (function attachTelegramSizing(){
        var tg = window.Telegram && window.Telegram.WebApp;
        function applySize() {
          if (tg) {
            tg.expand();
            // Use Telegram's reported viewport height to avoid scrollbars
            var vh = tg.viewportHeight || window.innerHeight;
            container.style.height = vh + 'px';
            canvas.style.height = vh + 'px';
            container.className = 'unity-mobile';
            config.devicePixelRatio = 1;
          } else {
            container.style.height = window.innerHeight + 'px';
            canvas.style.height = window.innerHeight + 'px';
          }
          container.style.width = '100vw';
          canvas.style.width = '100vw';
        }
        if (tg && tg.onEvent) {
          tg.onEvent('viewportChanged', applySize);
        }
        window.addEventListener('resize', applySize);
        applySize();
      })();

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = function () {
        createUnityInstance(canvas, config, function (progress) {})
          .then(function (unityInstance) {
            window.unityInstance = unityInstance;
            // No fullscreen button; Telegram manages chrome
          })
          .catch(function (message) {
            alert(message);
          });
      };
      document.body.appendChild(script);
    </script>
  </body>
  </html>


